@if(state == 1){
<div class="form-control mt-5 ">
  <h1 class="text-center">Add Book</h1>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Title</label>
      <input class="form-control" type="text" name="title" [(ngModel)]="addTitle" required>
    </div>

  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Author</label>
      <input class="form-control" type="text" name="author" [(ngModel)]="addAuthor" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Quantity</label>
      <input class="form-control" type="number" name="quantity" [(ngModel)]="addQuantity" required>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Price</label>
      <input class="form-control" type="number" name="price" [(ngModel)]="addPrice" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Price After Discount</label>
      <input class="form-control" type="number" name="priceAfterDiscount" [(ngModel)]="addPriceAfterDiscount">
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <label class="form-label">Description</label>
      <textarea class="form-control" name="description" [(ngModel)]="addDescription" required></textarea>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Image Cover <span class="text-danger">*</span></label>
      <input class="form-control" type="file" name="imageCover" accept="image/*" (change)="onImageCoverChange($event)" required>
      <img *ngIf="imageCoverPreview" [src]="imageCoverPreview" class="img-thumbnail mt-2" style="max-width: 120px; max-height: 120px;" />
    </div>
    <div class="col-md-6">
      <label class="form-label">Images (max 5)</label>
      <input class="form-control" type="file" name="images" accept="image/*" multiple (change)="onImagesChange($event)">
      <div class="d-flex flex-wrap mt-2">
        <img *ngFor="let img of imagesPreview" [src]="img" class="img-thumbnail me-2 mb-2" style="max-width: 70px; max-height: 70px;" />
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">PDF File</label>
      <input class="form-control" type="file" name="pdfLink" (change)="onPdfFileChange($event)" required>
    </div>

  </div>

  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Category</label>
      <select class="form-control" [(ngModel)]="selectedCategoryId" name="category">
        <option value="" disabled selected>Select Category</option>
        @for (cat of categories; track cat._id) {
          <option [value]="cat._id">{{cat.name}}</option>
        }
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Subcategory</label>
      <select class="form-control" [(ngModel)]="selectedSubcategoryId" name="subcategory">
        <option value="" disabled selected>Select Subcategory</option>
        @for (sub of subcategories; track sub._id) {
          <option [value]="sub._id" *ngIf="sub.category === selectedCategoryId">{{sub.name}}</option>
        }
      </select>
    </div>
  </div>
  <div *ngIf="formError" class="alert alert-danger mt-2">{{formError}}</div>
  <button (click)="addBook()" class="btn btn-primary form-control mt-3" [disabled]="isUploading">
    <span *ngIf="isUploading" class="spinner-border spinner-border-sm me-2" role="status"></span>
    {{ isUploading ? 'Uploading...' : 'Add New Book' }}
  </button>
</div>
}

@if(state == 2){
<div class="form-control mt-5 ">
  <h1 class="text-center">Update Book</h1>
  <h5 class="form-label text-center">Book ID: #{{selectedBookId}}</h5>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Title</label>
      <input class="form-control" type="text" name="title" [(ngModel)]="editBookName" required>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Author</label>
      <input class="form-control" type="text" name="author" [(ngModel)]="editBookAuthor" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Quantity</label>
      <input class="form-control" type="number" name="quantity" [(ngModel)]="editBookQuantity" required>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Price</label>
      <input class="form-control" type="number" name="price" [(ngModel)]="editBookPrice" required>
    </div>
    <div class="col-md-6">
      <label class="form-label">Price After Discount</label>
      <input class="form-control" type="number" name="priceAfterDiscount" [(ngModel)]="editBookPriceAfterDiscount">
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <label class="form-label">Description</label>
      <textarea class="form-control" name="description" [(ngModel)]="editBookDescription" required></textarea>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Image Cover <span class="text-danger">*</span></label>
      <input class="form-control" type="file" name="imageCover" accept="image/*" (change)="onImageCoverChange($event)">
      <img *ngIf="imageCoverPreview" [src]="imageCoverPreview" class="img-thumbnail mt-2" style="max-width: 120px; max-height: 120px;" />
    </div>
    <div class="col-md-6">
      <label class="form-label">Images (max 5)</label>
      <input class="form-control" type="file" name="images" accept="image/*" multiple (change)="onImagesChange($event)">
      <div class="d-flex flex-wrap mt-2">
        <img *ngFor="let img of imagesPreview" [src]="img" class="img-thumbnail me-2 mb-2" style="max-width: 70px; max-height: 70px;" />
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">PDF File</label>
      <input class="form-control" type="file" name="pdfLink" (change)="onPdfFileChange($event)">
    </div>

  </div>
  <div class="row">


  </div>
  <div class="row">
    <div class="col-md-6">
      <label class="form-label">Category</label>
      <select class="form-control" [(ngModel)]="editCategoryId" name="category">
        <option value="" disabled>Select Category</option>
        @for (cat of categories; track cat._id) {
          <option [value]="cat._id">{{cat.name}}</option>
        }
      </select>
    </div>
    <div class="col-md-6">
      <label class="form-label">Subcategory</label>
      <select class="form-control" [(ngModel)]="editSubcategoryId" name="subcategory">
        <option value="" disabled>Select Subcategory</option>
        @for (sub of subcategories; track sub._id) {
          <option [value]="sub._id" *ngIf="sub.category === editCategoryId">{{sub.name}}</option>
        }
      </select>
    </div>
  </div>
  <div *ngIf="formError" class="alert alert-danger mt-2">{{formError}}</div>
  <button (click)="updateBook()" class="btn btn-primary form-control mt-3" [disabled]="isUploading">
    <span *ngIf="isUploading" class="spinner-border spinner-border-sm me-2" role="status"></span>
    {{ isUploading ? 'Uploading...' : 'Update Book Data' }}
  </button>
</div>
}




<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Book Inventory</h5>
        <button (click)="canAddBook()" class="btn btn-sm btn-primary">
          <i class="bi bi-plus-circle"></i> Add New Book
        </button>
      </div>
      <div class="card-body">
        @if(isLoading) {
          <div class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading books...</p>
          </div>
        } @else {
          <div class="table-responsive">
            <table class="table table-hover table-striped">
              <thead class="table-light">
                <tr>
                  <th>Image cover</th>
                  <th>Title</th>
                  <th>Author</th>
                  <th>Category</th>
                  <th>Subcategory</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Sold</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody class="container">
                @for (book of booksInventory; track book._id) {
                <tr>
                  <td><img class="img-thumbnail" style="max-width:70px; max-height: 70px;" src="{{ book.imageCover}}" (error)="onImageError($event)" alt="{{ book.title }}"></td>
                  <td>{{ book.title }}</td>
                  <td>{{ book.author }}</td>
                  <td>
                    {{ getCategoryName(book.category) }}
                  </td>
                  <td>
                    <span class="badge bg-secondary">
                      {{ getSubcategoryNames(book.subcategory) }}
                    </span>
                  </td>
                  <td>{{ book.price }}LE</td>
                  <td>{{ book.quantity }}</td>
                  <td>{{ book.sold }}</td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button class="btn btn-outline-primary" (click)="viewBook(book._id)">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button class="btn btn-outline-success" (click)="editBook(book._id)">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-outline-danger" (click)="deleteBook(book._id)">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
      <div class="card-footer">
        <small class="text-muted">Showing {{ booksInventory.length }} books in inventory</small>
      </div>
    </div>
  </div>
</div>
